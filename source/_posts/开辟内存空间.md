---
title: å¼€è¾Ÿå†…å­˜ç©ºé—´
categories: iOSæºç æ¢ç©¶
tags: [iOS, objc, calloc]
---

å®ä¾‹å¯¹è±¡çš„å†…è—æ‰€å å¤§å°è®¡ç®—å®Œæˆåï¼Œæ¥ä¸‹æ¥è¦åšçš„å°±æ˜¯å¼€è¾Ÿå†…å­˜ç©ºé—´äº†ã€‚å¼€è¾Ÿå†…å­˜ç©ºé—´çš„æºç åœ¨ [libmalloc](https://opensource.apple.com/source/libmalloc/)ã€‚

<!-- more -->

æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼š

```objc
@interface SMPerson : NSObject

@property (nonatomic, copy) NSString *name;
@property (nonatomic, copy) NSString *address;
@property (nonatomic, assign) int age;
@property (nonatomic, assign) long height;

@end
```

åœ¨ main.m æ–‡ä»¶ä¸­

```objc
int main(int argc, const char * argv[]) {
    @autoreleasepool {
        SMPerson *person = [[SMPerson alloc] init];
        person.name = @"CC";
        person.age = 18;
        person.address = @"ä¸Šæµ·";
        person.height = 180;
        NSLog(@"\nperson å¯¹è±¡æ‰€å ç©ºé—´å¤§å°ï¼š%lu\nperson å¯¹è±¡åˆ†é…å†…å­˜ç©ºé—´å¤§å°ï¼š%lu",
              class_getInstanceSize([person class]),
              malloc_size((void *)person));
    }
    return 0;
}
```

æ§åˆ¶å°æ‰“å°çš„å€¼ä¸ºå¤šå°‘å‘¢ï¼Ÿä¾æ®ä¸Šä¸€èŠ‚æˆ‘ä»¬è®²åˆ°å†…å­˜å¯¹é½ï¼Œå¯¹è±¡åˆ›å»ºæ‰€éœ€è¦çš„å†…å­˜ç©ºé—´åº”è¯¥æ˜¯ `40`ã€‚

![calloc.png](https://i.loli.net/2019/12/28/zkT68uAZGdVh4Sb.png)

å¯¹è±¡æ‰€éœ€è¦çš„å†…å­˜çš„ç¡®æ˜¯`40`å­—èŠ‚ï¼Œä½†æ˜¯å¯¹è±¡æ‰€å¼€è¾Ÿçš„ç©ºé—´å¹¶ä¸ä¸€å®šå°±ç­‰äºæ­¤ã€‚ä½†æ˜¯è¿™ä¸ªåŸå› ä»€ä¹ˆçš„ï¼Œè¿™å°±éœ€è¦æˆ‘ä»¬å¯¹`calloc`æ–¹æ³•è¿›ä¸€æ­¥æ¢ç´¢ã€‚

æˆ‘ä»¬å·²ç»çŸ¥é“å¯¹è±¡åˆ›å»ºéœ€è¦`40`å­—èŠ‚çš„å†…å­˜ç©ºé—´ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥åˆ†é…`40`å­—èŠ‚çš„å†…å­˜ç©ºé—´ï¼Œå³

```objc
void *p = calloc(1, 40);
```

è·Ÿè¸ªæ–¹æ³•è°ƒç”¨çš„è¿‡ç¨‹ï¼Œæœ€åæ¥åˆ°:

![slot_bytes.png](https://i.loli.net/2019/12/28/6srHFCYEgn2yebo.png)

å› ä¸ºæˆ‘ä»¬æ­¤è¡Œå…³æ³¨çš„ç‚¹åœ¨äºå†…å­˜ç©ºé—´çš„å¤§å°ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡ç‚¹çœ‹æ–¹æ³•`segregated_size_to_fit`ã€‚

```objc
static MALLOC_INLINE size_t
segregated_size_to_fit(nanozone_t *nanozone, size_t size, size_t *pKey)
{
	size_t k, slot_bytes;

	if (0 == size) {
		size = NANO_REGIME_QUANTA_SIZE; // Historical behavior
	}
	k = (size + NANO_REGIME_QUANTA_SIZE - 1) >> SHIFT_NANO_QUANTUM; // round up and shift for number of quanta
	slot_bytes = k << SHIFT_NANO_QUANTUM;							// multiply by power of two quanta size
	*pKey = k - 1;													// Zero-based!

	return slot_bytes;
}
```
```objc
#define SHIFT_NANO_QUANTUM		4
#define NANO_REGIME_QUANTA_SIZE	(1 << SHIFT_NANO_QUANTUM) // 16
```
çœ‹åˆ°è¿™ä¸ªæ–¹æ³•æ˜¯ä¸æ˜¯å¾ˆçœ¼ç†Ÿ ğŸ™‚

æˆ‘ä»¬å°†å˜é‡å’Œå®å®šä¹‰éƒ½æ¢ç®—æˆæ•°å­—

```objc
k = (40 + 16 - 1) >> 4
slot_bytes = k << 4
```
`slot_bytes` æ˜¯ä¸æ˜¯å°±æ˜¯å¯¹ `size` çš„ `16` å­—èŠ‚å¯¹é½ï¼Œæ¢è¨€ä¹‹ï¼Œå†…å­˜åœ¨å¼€è¾Ÿç©ºé—´æ—¶ï¼Œç©ºé—´çš„å¤§å°éƒ½æ˜¯ `16` å­—èŠ‚çš„å€æ•°ï¼Œæ¯ä¸ªå¯¹è±¡çš„å†…å­˜å…¶å®åœ°å€ä¹Ÿéƒ½æ˜¯ `16`å­—èŠ‚çš„å€æ•°ã€‚

åˆ°è¿™ï¼Œæ˜¯ä¸æ˜¯å°±è§£å¼€äº†ä¸Šé¢ä¸ºä»€ä¹ˆ `SMPerson` å¯¹è±¡å¼€è¾Ÿçš„å†…å­˜ç©ºé—´æ˜¯ `48` è€Œä¸æ˜¯ `40` äº†ã€‚

æˆ‘ä»¬å¯ä»¥å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š

* å¯¹è±¡åˆ›å»ºæ—¶æ‰€éœ€çš„å†…å­˜ç©ºé—´æ˜¯ `8` çš„å€æ•°
* å¯¹è±¡åˆ›å»ºæ—¶å¼€è¾Ÿçš„å†…å­˜ç©ºé—´æ˜¯ `16` çš„å€æ•°

è¿™æ ·æ˜¯ä¸æ˜¯ä¹Ÿèƒ½è§£é‡Šä¸ºä»€ä¹ˆå¯¹è±¡åœ¨åˆ›å»ºå¯¹è±¡æ˜¯ï¼Œè®¡ç®—å‡ºæ¥çš„å†…å­˜ç©ºé—´è‡³å°‘æ˜¯ `16` å­—èŠ‚å‘¢ï¼Ÿå½“ç„¶è¿™åªæ˜¯æˆ‘çš„çŒœæƒ³ï¼Œå› ä¸ºå°±ç®—ä¸Šé¢æŒ‡å®šè‡³å°‘ä¸º `16` å­—èŠ‚ï¼Œä¹Ÿå¹¶ä¸èƒ½å†å¼€è¾Ÿå†…å­˜ç©ºé—´æ—¶å‡å°‘è®¡ç®—çš„æ—¶é—´ã€‚

æ¥ä¸€å¼  `calloc` çš„æµç¨‹å›¾ï¼š

![calloc.jpg](https://i.loli.net/2019/12/29/4jY7iJfdFDb8nkH.png)
